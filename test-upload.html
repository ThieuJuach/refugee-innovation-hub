<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Image Upload</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Image Upload Test</h1>

    <!-- Test 1: File Upload -->
    <div class="test-section">
        <h2>Test 1: Upload Local File</h2>
        <input type="file" id="fileInput" accept="image/*">
        <button onclick="testFileUpload()">Upload File</button>
        <div id="fileResult" class="result"></div>
    </div>

    <!-- Test 2: URL Input -->
    <div class="test-section">
        <h2>Test 2: Submit with Image URL</h2>
        <label>Image URL:</label>
        <input type="url" id="urlInput" placeholder="https://example.com/image.jpg" value="https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=800">
        <label>Title:</label>
        <input type="text" id="titleInput" value="Test Story">
        <button onclick="testUrlSubmission()">Submit with URL</button>
        <div id="urlResult" class="result"></div>
    </div>

    <!-- Test 3: Full Submission -->
    <div class="test-section">
        <h2>Test 3: Full Story Submission</h2>
        <form id="testForm">
            <label>Title:</label>
            <input type="text" name="title" value="Test Innovation Story" required>

            <label>Innovator Name:</label>
            <input type="text" name="innovator_name" value="Test Innovator" required>

            <label>Description:</label>
            <textarea name="description" required>This is a test innovation story to verify the upload functionality.</textarea>

            <label>Region:</label>
            <select name="region" required>
                <option value="East Africa">East Africa</option>
                <option value="Middle East">Middle East</option>
            </select>

            <label>Theme:</label>
            <select name="theme" required>
                <option value="Education">Education</option>
                <option value="Health">Health</option>
            </select>

            <label>Impact:</label>
            <input type="text" name="impact" value="Positive impact on community" required>

            <label>Location:</label>
            <input type="text" name="location" value="Nairobi, Kenya" required>

            <label>Contact Email:</label>
            <input type="email" name="contact_email" value="test@example.com" required>

            <label>Upload File:</label>
            <input type="file" name="image" id="formFileInput" accept="image/*">

            <label>OR Image URL:</label>
            <input type="url" name="image_url" id="formUrlInput" placeholder="https://example.com/image.jpg">

            <button type="submit">Submit Full Story</button>
        </form>
        <div id="formResult" class="result"></div>
    </div>

    <script src="api/php-api-client.js"></script>
    <script>
        // Initialize API client
        const api = new PHPAPIClient();

        console.log('API Base URL:', api.baseUrl);

        async function testFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('fileResult');

            if (!fileInput.files || fileInput.files.length === 0) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Please select a file first.';
                return;
            }

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            resultDiv.className = 'result';
            resultDiv.textContent = 'Uploading...';

            try {
                const { data, error } = await api.uploadFile(formData);

                if (error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Error: ' + error;
                    console.error('Upload error:', error);
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `Success! File uploaded to: <br><strong>${data.url}</strong><br><img src="${data.url}" style="max-width: 100%; margin-top: 10px;">`;
                    console.log('Upload success:', data);
                }
            } catch (err) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Exception: ' + err.message;
                console.error('Upload exception:', err);
            }
        }

        async function testUrlSubmission() {
            const urlInput = document.getElementById('urlInput');
            const titleInput = document.getElementById('titleInput');
            const resultDiv = document.getElementById('urlResult');

            if (!urlInput.value) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Please enter an image URL.';
                return;
            }

            const formData = new FormData();
            formData.append('title', titleInput.value);
            formData.append('innovator_name', 'Test User');
            formData.append('description', 'Test description for URL submission');
            formData.append('region', 'East Africa');
            formData.append('theme', 'Education');
            formData.append('impact', 'Test impact');
            formData.append('location', 'Test Location');
            formData.append('contact_email', 'test@example.com');
            formData.append('image_url', urlInput.value);

            resultDiv.className = 'result';
            resultDiv.textContent = 'Submitting...';

            try {
                const { data, error } = await api.submitStory(formData);

                if (error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Error: ' + error;
                    console.error('Submission error:', error);
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `Success! Story submitted with ID: <strong>${data.id}</strong><br>Image URL: ${urlInput.value}`;
                    console.log('Submission success:', data);
                }
            } catch (err) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Exception: ' + err.message;
                console.error('Submission exception:', err);
            }
        }

        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const resultDiv = document.getElementById('formResult');

            const formData = new FormData(form);

            // Check if file or URL is provided
            const hasFile = form.image.files && form.image.files.length > 0;
            const hasUrl = form.image_url.value.trim() !== '';

            if (!hasFile && !hasUrl) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Please provide either a file or an image URL.';
                return;
            }

            resultDiv.className = 'result';
            resultDiv.textContent = 'Submitting full story...';

            try {
                const { data, error } = await api.submitStory(formData);

                if (error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Error: ' + error;
                    console.error('Full submission error:', error);
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `Success! Full story submitted with ID: <strong>${data.id}</strong>`;
                    console.log('Full submission success:', data);
                }
            } catch (err) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Exception: ' + err.message;
                console.error('Full submission exception:', err);
            }
        });
    </script>
</body>
</html>
